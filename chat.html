<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Простой Мессенджер с Комнатами</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; background: #121212; color: #eee; display: flex; flex-direction: column; height: 100vh; }
        #chat { flex: 1; overflow-y: auto; padding: 10px; background: #222; }
        #input-area { display: flex; padding: 10px; background: #181818; }
        #message { flex: 1; padding: 10px; font-size: 1rem; border: none; border-radius: 4px; }
        #username { width: 150px; padding: 10px; font-size: 1rem; border: none; border-radius: 4px; margin-right: 10px; }
        #room { width: 150px; padding: 10px; font-size: 1rem; border: none; border-radius: 4px; margin-right: 10px; background: #333; color: #eee; }
        #send { margin-left: 10px; padding: 10px 20px; font-size: 1rem; border: none; border-radius: 4px; background: #4CAF50; color: white; cursor: pointer; }
        #send:disabled { background: #666; cursor: not-allowed; }
        .msg { margin-bottom: 10px; padding: 8px; border-radius: 4px; }
        .msg.you { text-align: right; background: #4CAF50; color: white; }
        .msg.server { text-align: left; background: #ff5722; color: white; }
        .msg.notification { text-align: center; color: #999; font-style: italic; }
        #status { font-size: 0.9rem; padding: 5px 10px; background: #333; }
    </style>
</head>
<body>
    <div id="status">Подключение...</div>
    <div id="chat"></div>
    <div id="input-area">
        <input id="username" type="text" placeholder="Ваше имя..." autocomplete="off" />
        <select id="room">
            <option value="chat1">Чат 1</option>
            <option value="chat2">Чат 2</option>
            <option value="chat3">Чат 3</option>
        </select>
        <input id="message" type="text" placeholder="Напиши сообщение..." autocomplete="off" />
        <button id="send" disabled>Отправить</button>
    </div>

    <script src="https://js.pusher.com/7.2/pusher.min.js"></script>
    <script>
        const chat = document.getElementById('chat');
        const messageInput = document.getElementById('message');
        const usernameInput = document.getElementById('username');
        const roomSelect = document.getElementById('room');
        const sendBtn = document.getElementById('send');
        const status = document.getElementById('status');

        // Подключение к Pusher
        const pusher = new Pusher('f7fd4b39376a65e065f6', {
            cluster: 'eu'
        });

        // Начальная комната
        let currentRoom = roomSelect.value;
        let channel = pusher.subscribe(currentRoom);

        // Привязка событий для сообщений
        channel.bind('message', (data) => {
            addMessage(data.message, data.type || 'server');
        });

        // Уведомление о подключении
        pusher.connection.bind('connected', () => {
            status.textContent = 'Подключено к серверу';
            sendBtn.disabled = false;
            if (usernameInput.value.trim()) {
                sendNotification(`${usernameInput.value.trim()} присоединился`);
            }
        });

        pusher.connection.bind('error', () => {
            status.textContent = 'Ошибка подключения';
            sendBtn.disabled = true;
        });

        // Смена комнаты
        roomSelect.addEventListener('change', () => {
            const oldRoom = currentRoom;
            currentRoom = roomSelect.value;
            channel.unbind_all();
            pusher.unsubscribe(oldRoom);
            channel = pusher.subscribe(currentRoom);
            channel.bind('message', (data) => {
                addMessage(data.message, data.type || 'server');
            });
            chat.innerHTML = ''; // Очищаем чат при смене комнаты
            status.textContent = `Подключено к ${currentRoom}`;
            if (usernameInput.value.trim()) {
                sendNotification(`${usernameInput.value.trim()} присоединился`);
            }
        });

        function addMessage(text, type) {
            const div = document.createElement('div');
            div.className = 'msg ' + (type === 'you' ? 'you' : type === 'notification' ? 'notification' : 'server');
            div.textContent = text;
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }

        function sendNotification(message) {
            fetch('https://api.pusherapp.com/apps/2035884/events', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer 563f569412d05512e4fe'
                },
                body: JSON.stringify({
                    name: 'message',
                    channel: currentRoom,
                    data: JSON.stringify({ message, type: 'notification' })
                })
            });
        }

        sendBtn.addEventListener('click', () => {
            const username = usernameInput.value.trim();
            const text = messageInput.value.trim();
            if (!username || !text) {
                alert('Введите имя и сообщение!');
                return;
            }
            const message = `${username}: ${text}`;
            fetch('https://api.pusherapp.com/apps/2035884/events', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer 563f569412d05512e4fe'
                },
                body: JSON.stringify({
                    name: 'message',
                    channel: currentRoom,
                    data: JSON.stringify({ message, type: 'you' })
                })
            });
            addMessage(message, 'you');
            messageInput.value = '';
            messageInput.focus();
        });

        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !sendBtn.disabled) {
                sendBtn.click();
            }
        });

        usernameInput.addEventListener('input', () => {
            sendBtn.disabled = !usernameInput.value.trim();
        });
    </script>
</body>
</html>